<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="simple.css" />
  <link rel="stylesheet" href="style.css" />
  <title>Speech Tests</title>

  <script>
    const zeroPad = (num, places) => String(num).padStart(places, '0')

    const format_srt_timestamp = (seconds) => {
      milliseconds = Math.round(seconds * 1000.0)

      hours = Math.floor(milliseconds / 3_600_000)
      milliseconds -= hours * 3_600_000

      minutes = Math.floor(milliseconds / 60_000)
      milliseconds -= minutes * 60_000

      seconds = Math.floor(milliseconds / 1_000)
      milliseconds -= seconds * 1_000

      return `${zeroPad(hours, 2)}:${zeroPad(minutes, 2)}:${zeroPad(seconds, 2)},${zeroPad(milliseconds, 3)}`
    }

    const upload = (file) => {
      // disable UI elements
      file_upload.disabled = true
      record_btn.disabled = true
      // update UI infos
      src_file.textContent = `Filename: ${file.name}\n(Size: ${file.size} Bytes, Type: ${file.type})`
      src_lang.value = ''
      tgt_text.textContent = ''

      const formData = new FormData()
      formData.append('file', file)
      if (tgt_lang.value) {
        formData.append('tgt_lang', tgt_lang.value)
      }
      fetch('/transcribe_upload/', {
        method: 'POST',
        headers: {
          'Accept': 'application/json'
        },
        body: formData,
      })
        .then((res) => res.json())
        .then((json) => {
          src_lang.value = json.src_lang
          let srt = ''
          for (i = 0; i < json.segments.length; i++) {
            const segment = json.segments[i]
            srt += segment.id + 1 + '\n'
            srt += format_srt_timestamp(segment.start) + ' --> ' + format_srt_timestamp(segment.end) + '\n'
            srt += segment.text + '\n\n'
          }
          tgt_text.textContent = srt
          // reactivate UI elements
          file_upload.disabled = false
          record_btn.disabled = false
          record_btn.classList.remove('transform-active')
        })
        .catch(
          (error) => console.log(error)
        )
    }

    const start_recording = async () => {
      record_btn.removeEventListener('click', start_recording)
      record_btn.addEventListener('click', stop_recording)
      // disable UI elements
      file_upload.disabled = true
      // reset UI infos
      src_file.textContent = ''
      src_lang.value = ''
      tgt_text.textContent = ''

      record_btn.classList.add('transform-active')  // start button animation
      media_recorder.start()
      timeout_id = setTimeout(() => {
        media_recorder.stop()
      }, 25000)
    }

    const stop_recording = async () => {
      media_recorder.stop()
    }

    window.onload = async () => {
      const file_upload = document.getElementById("file_upload")
      const file_drop = document.getElementById("file_drop")
      const record_btn = document.getElementById("record_btn")
      const src_file = document.getElementById('src_file')
      const src_lang = document.getElementById('src_lang')
      const tgt_lang = document.getElementById('tgt_lang')
      const tgt_text = document.getElementById('tgt_text')
      // init file select action
      file_upload.addEventListener("change", async (e) => {
        upload(file_upload.files[0])
        file_upload.value = null
      })
      // init dropdown action
      file_drop.ondragenter = async (e) => {
        e.stopPropagation()
        e.preventDefault()
        if (e.target.classList.contains("dropzone")) {
          e.target.classList.add("dragover")
        }
      }
      file_drop.ondragleave = async (e) => {
        e.stopPropagation()
        e.preventDefault()
        if (e.target.classList.contains("dropzone")) {
          e.target.classList.remove("dragover")
        }
      }
      file_drop.ondragover = async (e) => {
        e.stopPropagation()
        e.preventDefault()
      }
      file_drop.ondrop = async (e) => {
        e.stopPropagation()
        e.preventDefault()
        if (e.target.classList.contains("dropzone")) {
          e.target.classList.remove("dragover")
        }
        const dt = e.dataTransfer
        const files = dt.files
        const count = files.length
        upload(files[0])
      }
      // init language dropdowns
      fetch('/languages', {
        headers: {
          'Accept': 'application/json'
        }
      })
        .then((res) => res.json())
        .then((json) => {
          for (let i = 0; i < json.length; i++) {
            const obj = json[i]
            const el = document.createElement('option')
            el.value = obj.language_id
            el.textContent = obj.language_name
            src_lang.appendChild(el)
            tgt_lang.appendChild(el.cloneNode(true))
          }
        })
        .catch(
          (error) => console.log(error)
        )
      // init change events
      tgt_lang.addEventListener('change', async (e) => {
        // reset UI infos       
        src_file.textContent = ''
        src_lang.value = ''
        tgt_text.textContent = ''
      })
      navigator.mediaDevices.getUserMedia({ audio: true })
        .catch(console.error)
        .then(stream => {
          media_recorder = new MediaRecorder(stream)
          let chunks = []
          media_recorder.ondataavailable = (e) => chunks.push(e.data)
          media_recorder.onstop = async (e) => {
            record_btn.removeEventListener('click', stop_recording)
            record_btn.addEventListener('click', start_recording)
            clearTimeout(timeout_id)
            record_btn.classList.remove('transform-active') // end button animation
            const blob = new Blob(chunks, { type: chunks[0].type })
            upload(blob)
            chunks = []
          }
          record_btn.addEventListener('click', start_recording)
        })
    }
  </script>
</head>

<body>
  <h1>Transcribe Upload</h1>
  <p>In the following demo, you can upload a file with audio content (can also be a video) to a REST service and receive
    a transcription. The files are deleted immediately after processing. Please don't use files with multiple minutes of
    content, because this would take a long time for uploading and processing in this demo instance.<br>
    You have 3 ways to upload content, either by file selection, by drag & drop or by recording.</p>
  <label for="file_upload">Open a File with Audio:</label>
  <input id="file_upload" type="file" accept="audio/*,video/*" />
  <div id="file_drop" class="dropzone">Drop a File with Audio here</div>
  <button id="record_btn" class="progress">Record up to 25 seconds of audio</button>

  <label for="src_file">Source file:</label>
  <pre id="src_file"></pre>
  <label for="src_lang">Source language:</label>
  <select id="src_lang" disabled>
    <option value="">Will be autodetected...</option>
  </select>
  <label for="tgt_lang">Target language:</label>
  <select id="tgt_lang">
    <option value="">No translation...</option>
  </select>
  <label for="tgt_text">Transcription:</label>
  <pre id="tgt_text"></pre>
</body>

</html>