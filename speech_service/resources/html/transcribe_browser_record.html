<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="simple.css" />
  <link rel="stylesheet" href="style.css" />
  <title>Speech Tests</title>

  <script>
    window.onload = function () {
      const status = document.getElementById('status')
      const transcript = document.getElementById('transcript')

      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        if (!MediaRecorder.isTypeSupported('audio/webm'))
          return alert('Browser not supported')
        const mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'audio/webm'
        })
        const socket = new WebSocket('ws://localhost:8200/transcribe_stream/')
        socket.onopen = () => {
          status.textContent = 'Connected'
          console.log({ event: 'onopen' })
          mediaRecorder.addEventListener('dataavailable', async (event) => {
            if (event.data.size > 0 && socket.readyState == 1) {
              socket.send(event.data)
            }
          })
          mediaRecorder.start(5000)
        }
        socket.onmessage = (message) => {
          const received = message.data
          if (received) {
            console.log(received)
            transcript.textContent += ' ' + received
          }
        }
        socket.onclose = () => {
          console.log({ event: 'onclose' })
          status.textContent = 'Disconnected'
        }
        socket.onerror = (error) => {
          console.log({ event: 'onerror', error })
        }
      })
    }
  </script>
</head>

<body>
  <h1>Transcribe Browser Record</h1>
  <p id="status">Connection status will go here</p>
  <p id="transcript"></p>
</body>

</html>