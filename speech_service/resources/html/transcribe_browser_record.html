<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="simple.css" />
  <link rel="stylesheet" href="style.css" />
  <title>Speech Tests</title>

  <script>
    const startAudio = async (audioCtx, meterElement) => {
      audioCtx.audioWorklet.addModule('js/RecorderProcessor.js')
        .catch((err) => {
          console.log(`The following audioWorklet.addModule error occurred: ${err}`);
        })
        .then(() => {
          navigator.mediaDevices.getUserMedia({ audio: true })
            .catch((err) => {
              console.log(`The following mediaDevices.getUserMedia error occurred: ${err}`);
            })
            .then(stream => {
              const audioTracks = stream.getAudioTracks()
              if (audioTracks.length !== 1) {
                throw new Error('Too many tracks!')
              }
              const audioTrack = audioTracks[0]

              const recorder = audioCtx.createMediaStreamSource(stream)
              // const gain = audioCtx.createGain()
              // gain.gain.setValueAtTime(10, audioCtx.currentTime)
              const compressor = audioCtx.createDynamicsCompressor()
              compressor.threshold.setValueAtTime(-50, audioCtx.currentTime);
              compressor.knee.setValueAtTime(40, audioCtx.currentTime);
              compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
              compressor.attack.setValueAtTime(0, audioCtx.currentTime);
              compressor.release.setValueAtTime(0.25, audioCtx.currentTime);

              const recorderWorklet = new AudioWorkletNode(audioCtx, 'recorder.worklet')

              var ws = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/transcribe_record/ws");
              ws.addEventListener('error', (e) => {
                console.log('WebSocket error: ', e);
              })
              ws.addEventListener('message', (e) => {
                transcript.textContent += e.data
              })

              recorder.connect(compressor)
              compressor.connect(recorderWorklet)
              recorderWorklet.connect(audioCtx.destination)

              recorderWorklet.port.onmessage = (e) => {
                console.log("SEND: " + e.data.length)
                ws.send(e.data.buffer)
              }
            })
        })
    }

    window.onload = async () => {
      const transcript = document.getElementById('transcript')
      const buttonEl = document.getElementById('button-start')
      const meterEl = document.getElementById('volume-meter')

      buttonEl.addEventListener('click', async () => {
        const audioCtx = new AudioContext()
        await startAudio(audioCtx, meterEl)
        audioCtx.resume()
        buttonEl.disabled = true
        buttonEl.textContent = 'Playing...'
      }, false)
    }
  </script>
</head>

<body>
  <h1>Transcribe Browser Record</h1>
  <p id="status">Connection status will go here</p>
  <p id="transcript"></p>

  <div class="p-3 mb-2 bg-slate-100 w-1/3 rounded text-sm">
    <input id="volume-meter" class="w-full bg-white" type="range" min="0" max="100" value="0" step="1" disabled>
  </div>
  <button id="button-start">START</button>
</body>

</html>