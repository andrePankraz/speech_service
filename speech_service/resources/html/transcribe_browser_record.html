<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="simple.css" />
  <link rel="stylesheet" href="style.css" />
  <title>Speech Tests</title>

  <script>
    const startAudio = async (context, meterElement) => {
      await context.audioWorklet.addModule('transcribe_browser_record_processor.js');
      const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const micNode = context.createMediaStreamSource(mediaStream);
      const transcribeBrowserRecordNode = new AudioWorkletNode(context, 'transcribe_browser_record_processor');
      transcribeBrowserRecordNode.port.onmessage = ({ data }) => {
        meterElement.value = data * 500;
      };
      micNode.connect(transcribeBrowserRecordNode).connect(context.destination);
    };

    window.onload = async () => {
      const buttonEl = document.getElementById('button-start');
      const meterEl = document.getElementById('volume-meter');
      buttonEl.disabled = false;
      meterEl.disabled = false;
      buttonEl.addEventListener('click', async () => {
        let audioContext = new AudioContext();
        await startAudio(audioContext, meterEl);
        audioContext.resume();
        buttonEl.disabled = true;
        buttonEl.textContent = 'Playing...';
      }, false);
      // const status = document.getElementById('status')
      // const transcript = document.getElementById('transcript')

      // navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
      //   if (!MediaRecorder.isTypeSupported('audio/webm'))
      //     return alert('Browser not supported')
      //   const mediaRecorder = new MediaRecorder(stream, {
      //     mimeType: 'audio/webm'
      //   })
      //   const socket = new WebSocket('ws://localhost:8200/transcribe_stream/')
      //   socket.onopen = () => {
      //     status.textContent = 'Connected'
      //     console.log({ event: 'onopen' })
      //     mediaRecorder.addEventListener('dataavailable', async (event) => {
      //       if (event.data.size > 0 && socket.readyState == 1) {
      //         socket.send(event.data)
      //       }
      //     })
      //     mediaRecorder.start(5000)
      //   }
      //   socket.onmessage = (message) => {
      //     const received = message.data
      //     if (received) {
      //       console.log(received)
      //       transcript.textContent += ' ' + received
      //     }
      //   }
      //   socket.onclose = () => {
      //     console.log({ event: 'onclose' })
      //     status.textContent = 'Disconnected'
      //   }
      //   socket.onerror = (error) => {
      //     console.log({ event: 'onerror', error })
      //   }
      // })
    }
  </script>
</head>

<body>
  <h1>Transcribe Browser Record</h1>
  <p id="status">Connection status will go here</p>
  <p id="transcript"></p>

  <div class="p-3 mb-2 bg-slate-100 w-1/3 rounded text-sm">
    <input id="volume-meter" class="w-full bg-white" type="range" min="0" max="100" value="0" step="1" disabled>
  </div>
  <button id="button-start" disabled>START</button>
</body>

</html>