<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="simple.css" />
  <link rel="stylesheet" href="style.css" />
  <title>Speech Tests</title>

  <script>
    const startAudio = async (context, meterElement) => {
      context.audioWorklet.addModule('js/RecorderProcessor.js')
        .catch(console.error)
        .then(() => {
          navigator.mediaDevices.getUserMedia({ audio: true })
            .catch(console.error)
            .then(stream => {
              const audioTracks = stream.getAudioTracks()
              if (audioTracks.length !== 1) {
                throw new Error('Too many tracks!')
              }
              const audioTrack = audioTracks[0]
              // console.log(audioTrack.getCapabilities()); // output capabilities
              const constraints = {
                audio: {
                  channelCount: 1,
                  sampleRate: 16000,
                  sampleSize: 16
                }
              }
              audioTrack.applyConstraints(constraints)
                .catch(console.error)
                .then(() => {
                  const source = context.createMediaStreamSource(stream)
                  const recorder = new AudioWorkletNode(context, 'recorder.worklet')
                  var ws = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/transcribe_record/ws");
                  ws.onmessage = (e) => {
                    transcript.textContent += e.data
                  };
                  source.connect(recorder).connect(context.destination)
                  recorder.port.onmessage = (e) => {
                      console.log("SEND: " + e.data.length)
                      ws.send(e.data.buffer)
                  }
                })
            })
        })
    }

    window.onload = async () => {
      const transcript = document.getElementById('transcript')
      const buttonEl = document.getElementById('button-start')
      const meterEl = document.getElementById('volume-meter')

      buttonEl.addEventListener('click', async () => {
        const audioContext = new AudioContext()
        await startAudio(audioContext, meterEl)
        audioContext.resume()
        buttonEl.disabled = true
        buttonEl.textContent = 'Playing...'
      }, false)
    }
  </script>
</head>

<body>
  <h1>Transcribe Browser Record</h1>
  <p id="status">Connection status will go here</p>
  <p id="transcript"></p>

  <div class="p-3 mb-2 bg-slate-100 w-1/3 rounded text-sm">
    <input id="volume-meter" class="w-full bg-white" type="range" min="0" max="100" value="0" step="1" disabled>
  </div>
  <button id="button-start">START</button>
</body>

</html>